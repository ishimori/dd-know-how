# 実例: 機能実装DD

担当者変更機能を実装したDDの実例です（匿名化済み）。

---

# DD-010: 担当者変更機能の実装

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2024-01-10 | 2024-01-10 | 完了 |

## 目的

アイテムの担当者変更機能（M-02: 担当者変更画面、M-03: 担当者登録画面）を実装する。
また、一覧画面（M-01）にヘッダーボタンと操作列ボタンを追加し、画面遷移を実現する。

## スコープ

### 本DDの対象範囲

| 機能 | 内容 |
|------|------|
| M-01 ヘッダーボタン追加 | 新規追加、履歴、削除一覧へのリンク |
| M-01 操作列ボタン | 担当者変更、削除ボタン（当日のみ有効） |
| M-02 担当者変更画面 | 既存担当者の変更 |
| M-03 担当者登録画面 | 担当者未登録のアイテムに担当者を登録 |

### 対象外（後続DDで実施）

| 機能 | DD |
|------|----|
| M-04 新規追加 | 後続DD |
| M-05 削除処理 | 後続DD |
| M-06 削除済み一覧 | 後続DD |

## 背景・課題

- DD-008で一覧画面を実装済み
- 現状、ヘッダーボタンと操作列ボタンが未実装
- 担当者変更は最も使用頻度の高い機能

## 検討内容

### 担当者選択方式の検討

| 方式 | メリット | デメリット |
|------|----------|------------|
| A. セレクトボックス | シンプル | 人数が多いと使いにくい |
| B. オートコンプリート | 検索しやすい | 実装複雑 |
| C. ラジオ + 入力切替 | 柔軟性が高い | UI複雑 |

**採用: 方式C（ラジオ + 入力切替）**
- 「メンバーから選択」と「フリー入力」を切り替え
- メンバー選択はセレクトボックス
- フリー入力は自由テキスト

## 決定事項

- **2024-01-10**: DD-010作成、M-02/M-03を優先実装
- **2024-01-10**: 既存システム分析完了、履歴パターンでの更新方式を確認
- **2024-01-10**: 担当者選択はラジオ + 入力切替方式を採用

## タスク一覧

### Phase 1: M-01 ボタン追加
- [x] `views/items/items_list.py`: ヘッダーボタン追加
  - [x] 新規追加ボタン（リンク先はスタブ）
  - [x] 履歴ボタン（リンク先はスタブ）
  - [x] 削除一覧ボタン（リンク先はスタブ）
  - [x] 締めボタン（管理者のみ、リンク先はスタブ）
- [x] `views/items/items_list.py`: 操作列ボタンの条件分岐
  - [x] 当日のみ有効化
  - [x] 担当者有無で「変更」/「登録」切り替え

### Phase 2: M-02/M-03 担当者変更・登録画面
- [x] `repositories/item_repository.py`: 追加メソッド
  - [x] `get_item_detail()`: アイテム詳細取得
  - [x] `get_assign_history()`: 担当者変更履歴取得
  - [x] `update_assignee()`: 担当者変更
  - [x] `add_assignee()`: 担当者登録
  - [x] `cancel_latest_change()`: 変更取消
- [x] `services/item_service.py`: ビジネスロジック追加
- [x] `views/items/items_assign.py`: 担当者変更画面
- [x] `views/items/items_assign_add.py`: 担当者登録画面

### Phase 3: テスト
- [x] テストコード作成 - `tests/test_items_assign.py`

## 詳細設計

### 画面遷移

```
[一覧 M-01]
    │
    ├── [ヘッダー] ─┬─ [新規追加 M-04] ※後続DD
    │              ├─ [締め M-08] ※後続DD（管理者のみ）
    │              ├─ [履歴 M-07] ※後続DD
    │              └─ [削除一覧 M-06] ※後続DD
    │
    └── [操作列] ──┬─ [担当者変更 M-02] ← 本DD
                  ├─ [担当者登録 M-03] ← 本DD
                  └─ [削除 M-05] ※後続DD
```

### M-02 担当者変更画面 設計

```
┌─────────────────────────────────────────────────────────────┐
│ 担当者変更                                    [← 一覧に戻る] │
├─────────────────────────────────────────────────────────────┤
│ アイテム名：会議室A                                          │
│ アイテムID：ITEM001                                         │
│ 現在の担当者：山田太郎                                       │
├─────────────────────────────────────────────────────────────┤
│ 変更日    [____日付ピッカー____]                            │
│ 新しい担当者                                                │
│   ○ メンバーから選択  [____セレクトボックス____]             │
│   ○ フリー入力        [____テキスト入力____]                │
│                                                             │
│             [更新]                                          │
├─────────────────────────────────────────────────────────────┤
│ 変更履歴                                                    │
│ ┌──────────┬────────────┬────────────┬────────┐            │
│ │ 変更日    │ 変更前      │ 変更後      │ 操作   │            │
│ ├──────────┼────────────┼────────────┼────────┤            │
│ │ 2024/01/05│ 鈴木次郎    │ 山田太郎    │ [取消] │            │
│ │ 2024/01/01│ （なし）    │ 鈴木次郎    │ [取消] │            │
│ └──────────┴────────────┴────────────┴────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## 実装前チェック

### チェック実施日: 2024-01-10

#### 1. 仕様書確認
- 参照ファイル: `doc/spec/04_画面一覧.md` - M-02, M-03 画面仕様
- 確認結果: 変更日、新しい担当者（メンバー検索 or フリー入力）、変更履歴表示

#### 2. 既存コード確認
- 参照ファイル: `src/controllers/items_controller.py`
- 確認結果: assign() - 担当者変更、assignCancel() - 変更取消

#### 3. 設計書との差分
- 漏れている仕様: なし
- 追加で必要な対応: メンバーマスタからの検索機能

## テストシナリオ

### M-02 担当者変更画面

#### 正常系
- [x] 一覧から「担当者変更」ボタンをクリックすると、担当者変更画面に遷移
- [x] アイテム名、アイテムID、現在の担当者が表示される
- [x] 変更日を選択できる（最小値は前回変更日の翌日）
- [x] メンバーから選択 or フリー入力で新しい担当者を入力できる
- [x] 「更新」ボタンで担当者が変更される
- [x] 変更後、一覧画面にリダイレクトされる
- [x] 「取消」ボタンで最新の変更を取り消せる

#### 異常系
- [x] 変更日が最小値より前の場合、エラー
- [x] 新しい担当者が未入力の場合、エラー

## ログ

### 2024-01-10
- DD-010作成
- 既存システム分析完了
- 画面設計完了
- 実装前チェック完了
- テストシナリオ作成
- Phase 1 完了: M-01 ヘッダーボタン・操作列ボタン追加
- Phase 2 完了: M-02/M-03 画面実装
  - リポジトリ: `get_item_detail()`, `get_assign_history()`, `update_assignee()`, `add_assignee()`, `cancel_latest_change()`
  - サービス層追加
  - `items_assign.py`: 担当者変更画面（2カラムレイアウト、変更履歴表示、取消機能）
  - `items_assign_add.py`: 担当者登録画面
- Phase 3 完了: テスト作成（8件、全パス）
- DD-010 完了

---

## この実例のポイント

1. **スコープの明確化**: 対象範囲と対象外を明記し、DDの境界を明確に
2. **検討内容の記録**: 3つの方式を比較し、採用理由を記録
3. **フェーズ分割**: Phase 1, 2, 3 でタスクを整理
4. **詳細設計**: ASCII図で画面レイアウトを表現
5. **実装前チェック**: 仕様書・既存コードを事前確認
6. **テストシナリオ**: 正常系・異常系を列挙
7. **ログの詳細**: 各フェーズの完了内容を具体的に記録
