# 実例: 設計判断DD

コーディング規約・設計方針を決定したDDの実例です（匿名化済み）。

---

# DD-003: コーディング規約・設計方針

| 作成日 | 更新日 | ステータス |
|--------|--------|------------|
| 2024-01-10 | 2024-01-10 | 完了 |

## 目的

AIアシスタントが**正しいコードを書く**ための指針を定義する。
アプリケーションのアーキテクチャ、コーディング規約、品質チェックの仕組みを確立する。

## 背景・課題

- コード生成をAIに任せると、一貫性のないコードが生成される恐れがある
- 旧システムからの移行で、旧システム風のコードが生成されるリスク
- AIが書いたコードの検証ルールが必要

## 検討内容

### 1. コード品質管理

#### 1-1. コーディング規約の厳格定義
- サンプルコード付きで「こう書く」を明示
- アンチパターンも併記（「こう書かない」）
- 疎結合を意識した設計パターンを定義

#### 1-2. テンプレート・スニペット
- 新規ファイル作成時のテンプレート
- よく使うパターンのスニペット集
- AIが参照して一貫したコードを生成

#### 1-3. レビューチェックリスト
- AIが生成したコードの自己チェック項目
- 人間がレビューする際のポイント

### 2. 仕様書の書き方（AIフレンドリー）

#### 2-1. 構造化・機械可読性

| 観点 | 理由 |
|------|------|
| 明確な階層構造 | Markdownの見出しで論理構造を把握しやすい |
| テーブル形式の定義 | 項目・型・制約などを一覧で把握できる |
| 一貫した命名規則 | 変数名・関数名の推測が容易になる |

#### 2-2. コード生成に直結する情報

| 観点 | 例 |
|------|-----|
| データ型の明示 | `string`, `int`, `datetime`, `boolean` |
| バリデーションルール | 必須、文字数制限、形式（メール、電話等） |
| 状態遷移 | ステータスの取りうる値と遷移条件 |
| 計算ロジック | 数式、条件分岐を擬似コードで |

## 決定事項

### 外部レビュー結果を踏まえた決定（2024-01-09）

1. **優先順位**: Architecture.md → Coding-standards.md → Glossary.md
2. **追加で必要な要素**:

| 要素 | 理由 |
|------|------|
| **テスト戦略** | AIが書いたコードの検証ルールが必要 |
| **移行パターン辞書** | 実装パターンの対比表がないと旧システム風のコードが生成される |
| **禁止事項（鉄の掟）** | 「やってはいけないこと」の明文化が制御に有効 |
| **Lint/Format設定** | 言葉で説明するより設定ファイル自体を参照させる |

### アーキテクチャ決定（2024-01-10）

| 項目 | 決定 |
|------|------|
| レイヤー構成 | views → services → repositories → models |
| マルチページ | 標準的なルーティング方式を採用 |
| Session State | Repository経由（直接アクセス禁止） |
| DB接続 | 生SQL（ORMは使わない） |
| エラーハンドリング | 例外パターン（Result型は使わない） |
| ロギング | stdout出力、`logging.getLogger(__name__)` |

### コード検証の仕組み（2024-01-10）

| 検証方法 | 内容 |
|----------|------|
| **自動チェック（Linter）** | `ruff check src/ --fix && ruff format src/` |
| **セルフチェック（AI）** | Session State直接アクセス、依存方向、仕様書準拠 |
| **動作確認** | 実際にアプリを起動して確認 |

## タスク一覧

### 優先度：高
- [x] Architecture.md（設計方針・Session State等）の作成
- [x] Linter設定（pyproject.toml）の整備
- [x] セルフチェック項目の定義（src/CLAUDE.md）
- [x] Coding-standards.md（正解例 & アンチパターン）の作成

### 優先度：中
- [-] 旧システム→新システム移行パターン対比表の作成（実装経験を積み、必要性低下）
- [-] 禁止事項（鉄の掟）ドキュメントの作成（coding-standards.mdのアンチパターンでカバー）
- [x] Testing-guidelines.md（テスト戦略）の作成

### 優先度：低
- [-] テンプレート・スニペット作成（実装パターンが確立、スキップ）
- [-] レビューチェックリスト作成（/reviewコマンドでカバー）

## 成果物

| ファイル | 状態 | 説明 |
|----------|------|------|
| `.claude/architecture.md` | 完了 | 設計指針 |
| `pyproject.toml` | 完了 | Linter設定 |
| `src/CLAUDE.md` | 完了 | コード検証セクション |
| `.claude/coding-standards.md` | 完了 | コーディング規約（8パターン） |
| `.claude/testing-guidelines.md` | 完了 | テスト戦略 |

## ログ

### 2024-01-10（DD作成）
- DD-002「AI開発スタイル」からコード品質関連を分離
- DD-003「コーディング規約・設計方針」として独立
- 目的を明確化: AIが「正しいコードを書く」ための指針
- 既存の成果物を整理:
  - Architecture.md: 完了
  - Linter設定: 完了
  - セルフチェック: 完了

### 2024-01-10（Coding-standards.md作成）
- Architecture.mdをベースに8パターンのコーディング規約を作成
- 各パターンに「正解例」と「アンチパターン」のペアを記載
- カバー範囲:
  1. Session State（SessionRepo経由）
  2. レイヤー構成と依存方向
  3. データベースアクセス（生SQL）
  4. エラーハンドリング（カスタム例外）
  5. ロギング
  6. 画面ファイル構成
  7. UI部品（st.form）
  8. import文

### 2024-01-10（DD完了）
- 12件の機能実装を通じて規約が実践で検証済み
- 残タスクの見直し:
  - 移行パターン対比表: 実装経験で習熟、スキップ
  - 禁止事項: coding-standards.mdのアンチパターンでカバー済み
  - テンプレート・スニペット: 実装パターンが確立、スキップ
  - レビューチェックリスト: /reviewコマンドでカバー済み
- DDをアーカイブ

---

## この実例のポイント

1. **背景・課題の明確化**: なぜこのDDが必要かを具体的に記載
2. **検討内容の構造化**: 複数の観点を表形式で整理
3. **外部レビューの反映**: 外部からのフィードバックを決定事項に反映
4. **優先度付きタスク**: 高・中・低の優先度でタスクを分類
5. **スキップの理由記録**: `[-]` タスクにスキップ理由を明記
6. **成果物リスト**: DDの成果物を一覧化
7. **詳細なログ**: 判断の経緯と実施内容を時系列で記録

## 機能実装DDとの違い

| 観点 | 機能実装DD | 設計判断DD |
|------|-----------|-----------|
| 主な内容 | 画面・機能の実装 | 方針・規約の策定 |
| 成果物 | ソースコード | ドキュメント・設定ファイル |
| タスク粒度 | 細かい（ファイル単位） | 大きい（ドキュメント単位） |
| 検討内容 | 実装方式の比較 | アーキテクチャ・方針の比較 |
| スコープ | 特定の機能 | プロジェクト全体 |

設計判断DDは、プロジェクト全体に影響する意思決定を記録するのに適しています。
