---
name: dd
description: DD設計書操作コマンド（仕様書連携付き）
---

# DD設計書操作コマンド（仕様書連携付き）

DD（Design Document）設計書を操作するコマンドです。
Level 3では、アーカイブ時に仕様書同期チェックが自動実行されます。

## 引数の解釈

### DD番号の指定（柔軟に解釈する）
以下はすべて同じDD-001を指す：
- `DD-001` / `DD 001` / `DD001` / `001` / `1`

→ 番号部分（数字）を抽出して3桁にゼロパディング（1 → 001）

### 識別子付きDD（チーム開発時）
識別子付きの場合も同様に柔軟に解釈：
- `DDI-001` / `DDI 001` / `DDI001`（石森のDD）
- `DDSA-001` / `DDSA001`（斉藤のDD）

→ 識別子部分（DD直後のアルファベット）と番号部分を抽出

### コマンド
- `{番号}` → 該当DDを参照
- `new タイトル` → 新規DD作成
- `list` → 進行中DD一覧
- `status` → 現在の開発ステップを表示
- `archive {番号}` → DDをアーカイブ（仕様書同期チェック付き）
- `update {番号}` → DDを更新（ログ追記含む）

## 操作手順

### 参照（DD-001, 001 など）
1. `doc/DD/DD-{番号}_*.md` を検索（メインファイルは常に直下）
2. なければ `doc/archived/DD/DD-{番号}_*.md` を検索
3. **DD本体のみ読み込む**（リンク先は自動で読み込まない）
4. 内容を要約して表示
5. 添付フォルダ `doc/DD/DD-{番号}/` があれば、その存在とファイル一覧を通知
6. 「何をしますか？」と確認

#### リンク先の自動読み込み防止（重要）

**デフォルト動作**: DD参照時はDD本体（.mdファイル）のみ読み込む。

以下は**自動で読み込まない**：
- 添付フォルダ内のファイル（HTML、画像等）
- 参照ドキュメントへのリンク先
- 流用元・関連DDへのリンク先

**理由**: リンク先を自動で読み込むと、芋づる式にコンテキストを消費する。

**明示的な作業指示があった場合**:
ユーザーが具体的な作業を指示した場合は、必要なファイルを読み込んでよい：
- 「landing.htmlを修正して」→ landing.html を読み込む
- 「HTMLモックを全部確認して」→ 添付フォルダ内を読み込む
- 「関連DDも確認して」→ 関連DDを読み込む

これらは意図的な読み込みなので、コンテキスト消費は許容する。

### 新規作成（new タイトル）
1. **識別子の確認**
   - CLAUDE.mdに作業者識別子が設定されていれば使用（例: `作業者識別子: I`）
   - 未設定の場合は従来の `DD-{番号}` 形式
2. **既存DD番号の確認（重要）**
   - 識別子付き: `doc/DD/DD{識別子}-*.md` と `doc/archived/DD/DD{識別子}-*.md` を検索
   - 識別子なし: `doc/DD/DD-*.md` と `doc/archived/DD/DD-*.md` を検索
   - 該当する系列から最大番号を取得
3. 次の連番でファイルを作成
   - 識別子付き: `DD{識別子}-{連番}_{タイトル}.md`
   - 識別子なし: `DD-{連番}_{タイトル}.md`
4. テンプレートファイルをコピー: `doc/templates/dd_template.md` を読み込み、`{番号}` `{タイトル}` `{日付}` を置換

**注意**: 番号重複を防ぐため、必ずアーカイブ済みDDも含めて最大番号を確認すること

### 一覧（list）
1. `doc/DD/` 内のDD一覧を表示
2. 各DDのタイトルとステータスを表示

### ステータス確認（status）

現在の開発フローの進捗を表示する。

**出力フォーマット:**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 Step N/9: ステップ名
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 1. DD作成       ✅ 2. 仕様確認     ✅ 3. 実装前チェック
▶️ 4. コーディング  ⬜ 5. テスト作成   ⬜ 6. コード検証
⬜ 7. レビュー      ⬜ 8. 仕様書同期   ⬜ 9. コミット
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 対象DD: DD-XXX_機能名
```

**判定方法:**
1. 進行中のDDを `doc/DD/` から検索
2. DDの内容とgit statusを分析して現在のステップを推定

**進行中DDがない場合:**
```
📋 進行中のDDがありません

新しい機能開発を始めるには:
  /dd new 機能名
```

### アーカイブ（archive DD-001）
1. 該当DDの全タスクが完了しているか確認
2. **仕様書同期チェック**（自動実行）
   - DDの内容を分析し、`doc/spec/` への反映が必要な変更を検出
   - 検出結果を表示し、未反映項目があれば対応を促す
   - 詳細は「仕様書同期チェック」セクション参照
3. 同期が完了したら `doc/DD/` から `doc/archived/DD/` に移動
   - メインファイル `DD-{番号}_*.md` を移動
   - 添付フォルダ `DD-{番号}/` がある場合は**フォルダごと移動**

## DDテンプレート

テンプレートファイル: `doc/templates/dd_template.md`

新規DD作成時は、このファイルを読み込んで以下を置換する：
- `{番号}` → 3桁ゼロパディングの連番（例: 001）
- `{タイトル}` → ユーザー指定のタイトル
- `{日付}` → 作成日（YYYY-MM-DD形式）

### ステータスの種類
- **進行中** - 作業中のDD
- **完了** - 全タスク完了、アーカイブ待ち

## 注意事項

- DDを更新した場合は、必ず「ログ」セクションに記録を追加する
- タスク完了時は `[x]` に変更し、ログにも記録する

---

## 仕様書同期チェック

`/dd archive` 実行時に自動で実行される仕様書同期チェックの詳細。

### 目的

DDで決定・実装した内容が `doc/spec/` の仕様書に反映されているかを確認する。

### チェック対象

DDの内容から以下の変更を検出し、対応する仕様書との整合性を確認：

| 変更種別 | 検出キーワード | 関連仕様書 |
|----------|---------------|-----------|
| 画面の追加・変更 | 「画面」「UI」「表示」 | `doc/spec/03_画面仕様/` |
| テーブル・カラムの追加・変更 | 「テーブル」「カラム」「DB」 | `doc/spec/04_テーブル定義.md` |
| 機能の追加・変更 | 「機能」「追加」「実装」 | `doc/spec/02_機能一覧.md` |

**注意**: 上記のパスはプロジェクトの仕様書構成に合わせて調整してください。

### チェック手順

1. DDの「決定事項」「タスク一覧」「ログ」セクションを分析
2. 上記の変更種別に該当する内容を抽出
3. 関連する仕様書を読み込み、内容が反映されているか確認
4. 結果を表形式で出力

### 出力フォーマット

```markdown
## 仕様書同期チェック結果

### 検出された変更

| 変更内容 | 関連仕様書 | 反映状況 |
|----------|-----------|----------|
| ログイン画面を追加 | 03_画面仕様/login.md | ✅ 反映済 |
| usersテーブルにカラム追加 | 04_テーブル定義.md | ⚠️ 要確認 |

### 判定基準
- ✅ 反映済: 仕様書に該当内容が記載されている
- ⚠️ 要確認: 仕様書に該当内容が見つからない、または古い可能性

### 対応が必要な場合
⚠️ の項目がある場合は、仕様書を更新してから再度アーカイブを実行してください。
```

### アーカイブ可否の判定

- 全項目が ✅ の場合 → アーカイブ実行
- ⚠️ が1つ以上ある場合 → ユーザーに確認
  - 「仕様書を更新しますか？」と質問
  - 「このままアーカイブ」も選択可能（意図的にスキップする場合）

---

## 開発フロー

DD作業時は **必ず** `doc/development-flow-full.md` を読み込み、9ステップフローに従うこと。

### 必須事項

1. **各ステップ開始時に進捗表示を行う**
2. **Step 6（コード検証）でセルフチェックを実行**
3. **Step 7（レビュー）でセルフレビューを実行**

### 進捗表示フォーマット

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 Step N/9: ステップ名
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 1. DD作成       ✅ 2. 仕様確認     ✅ 3. 実装前チェック
▶️ 4. コーディング  ⬜ 5. テスト作成   ⬜ 6. コード検証
⬜ 7. レビュー      ⬜ 8. 仕様書同期   ⬜ 9. コミット
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

詳細は `doc/development-flow-full.md` を参照。

---

## Phase 0: 事前精査（CRITICAL）

### 重要度: 必須

**DD作成後、実装を始める前に必ずPhase 0を実施すること。**
Phase 0を完了せずにPhase 1以降を開始してはならない。

### Phase 0の目的

DDを作成した時点では、タスクが粗い粒度で書かれていることがある。
実装前に各Phaseのタスクを精査し、以下を確認・対応する：

1. **タスクの詳細化が必要か確認**
   - 曖昧なタスク（「〇〇を実装」など）がないか
   - 1つのタスクで複数の作業が混在していないか
   - 実装順序が明確か

2. **必要に応じてタスクを分解**
   - 大きすぎるタスクは2〜3個に分解
   - 依存関係があるものは順序を明確に
   - 具体的なファイル名・関数名を追記

3. **不足しているタスクの追加**
   - 前提条件の準備タスク
   - 動作確認・テストタスク
   - ドキュメント更新タスク

### 精査チェックリスト

| チェック項目 | 確認観点 |
|-------------|----------|
| タスク粒度 | 各タスクが1〜2時間程度で完了する粒度になっているか |
| 具体性 | 何をすればよいか明確に分かるか |
| 順序 | 実装順序が適切か、依存関係は明確か |
| 網羅性 | 必要なタスクがすべて含まれているか |

### 完了条件

以下をすべて満たしたらPhase 0完了：

1. すべてのPhaseのタスクを確認した
2. 必要な詳細化・分解を行った
3. タスク一覧がそのまま実装できる状態になった

### 記録方法

DDのログセクションに記録：

```markdown
### YYYY-MM-DD
- Phase 0 完了
  - Phase 1: タスクを3個に分解
  - Phase 2: ファイル名を追記
  - Phase 3: 変更なし
```

---

## Phase完了時のルール

DDのタスク一覧内の各Phaseが完了したら、Phase内容に応じたエージェントでレビューを実施する。

### エージェント選択基準

| Phase内容 | 使用エージェント |
|-----------|-----------------|
| 一般的なコード実装 | `code-reviewer` |
| 認証・認可・API・決済 | `security-reviewer` |
| 設計・アーキテクチャ | `architect` |
| DB設計・マイグレーション | `database-reviewer` |
| ドキュメント・その他 | 手動でセルフレビュー |

**注意**: 認証やAPIを含むコード実装では `code-reviewer` と `security-reviewer` の両方を使用すること。

### レビュー結果の記録

DDのログセクションに以下の形式で記録：

```
- Phase N 完了レビュー（{エージェント名}）: ✅ 問題なし / ⚠️ 要修正（修正内容）
```

### レビューで問題が見つかった場合

1. 問題を修正する
2. 再度レビューを実行
3. 問題なしになってからPhaseを完了とする

---

## Phase完了時の自己レビュー（CRITICAL）

### 重要度: 必須

**各Phaseを完了とする前に、以下を必ず実行すること。**
自己レビューなしにPhaseを完了としてはならない。

### 自己レビューチェックリスト

Phase完了時に以下を確認：

| チェック項目 | 確認観点 |
|-------------|----------|
| 要件充足 | Phase内のタスクがすべて完了し、要件を満たしているか |
| 規約遵守 | コーディング規約・命名規則に違反していないか |
| セキュリティ | 認証漏れ、SQLインジェクション等のリスクがないか |
| 動作確認 | 実際に動作させて期待通りに動くことを確認したか |

### 記録手順（3ステップ）

**Step 1: DDの「自己レビュー記録」セクションに記録**

```markdown
### Phase N 自己レビュー
- 日付: 2026-01-31
- チェック項目:
  - [x] 要件を満たしているか
  - [x] 規約違反がないか
  - [x] セキュリティリスクがないか
  - [x] 動作確認済みか
- 結果: ✅ 問題なし
- コメント: 特記事項なし
```

**Step 2: タスク一覧の「🔍 Claude自己レビュー」を完了にする**

```markdown
- [x] 🔍 **Claude自己レビュー**
```

**Step 3: ログに完了を記録**

```markdown
### 2026-01-31
- Phase 1 完了（自己レビュー済み）
```

### 問題が見つかった場合

1. 問題を修正する
2. 再度チェックリストを確認
3. すべてチェックできたら記録

### 強制ルール

- **自己レビュー記録がないPhaseは完了とみなさない**
- タスク一覧に「🔍 Claude自己レビュー」がない場合は追加する
- 問題があるままPhaseを完了にしない
